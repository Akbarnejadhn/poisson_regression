---
title: "Count Data, Poisson regression"
author: "Hana Akbarnejad"
date: "3/4/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(viridis)
library(ggplot2)
library(readr)
library(pscl)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r data_import}

crab_data = read_table2("HW5-crab.txt") %>% 
  janitor::clean_names()

parasite_data = read_table2("HW5-parasite.txt") %>% 
  janitor::clean_names() %>% 
  mutate(
    area= as.factor(area),
    year= as.factor(year)
  )
```

## Problem 1
### 1-a
Fit a Poisson model (M1) with log link with W(carapace width) as the single predictor. Check the goodness of fit and interpret your model.
```{r poi_w}

# fit poisson model
m1 = glm(sa ~ w, family=poisson(link = "log"), data=crab_data)
summary(m1)

# gof
deviance_m1 = m1$deviance
df_m1 =  m1$df.residual              # df=n-p  173-(1+1)=171
pval1=1-pchisq(deviance_m1,df=df_m1) # chisq test
pval1                                # pvalue is 0 this shows that the fit is not good
```

interpretation: .................
Assessing the goodness of fit of this model shows that the he p-value is `r round(pval1, 3)` which means that this model does not fit the data well.

### 1-b
Fit a model (M2) with W and Wt(weight) as predictors. Compare it with the model in (a). Interpret your results.
```{r poi_w_wt}

# fit poisson model
m2 = glm(sa ~ w+wt, family=poisson(link = "log"), data=crab_data)
summary(m2)

# compare m_2 and m_1
deviance_m2 = m2$deviance
df_m2 =  m2$df.residual             # df=n-p   173-(2+1)=170

test_stat =m1$deviance - m2$deviance
df =df_m1 - df_m2 
pval=1-pchisq(test_stat,df=df)      # chisq test
pval
```

interpretation: .................

Comparing the small model using only carapace width as predictor and the bigger model using both carapace width and weight as predictors, we can see that the p-value is `r round(pval, 3)`. This shows that we reject null hypothesis (stating that the smaller moddel is legible), and conclude that the bigger model is the one that we should pick and continue with.

### 1-c
Check over dispersion in M2. Interpret the model after adjusting for over dispersion.
```{r overdisp}

# calc dispersion parameter based on full model
p_res=residuals(m2,type='pearson',data=crab_data)
G=sum(p_res^2)
pval_disp=1-pchisq(G,df=170)
phi=G/170
phi
m2$deviance/m2$df.residual

summary(m2,dispersion=phi)

# # an equivalent way of estimating dispersion parameter
# wave.glm3 <- glm(damage~ship+year+period+offset(log(month)), family=quasi(link=log,variance=mu), data=wave, subset=month>0)
# summary(wave.glm3) # check ?quasi 
# 
# 
# # test over-dispersion (half normal plot)
# plot(qnorm((34+1:34+0.5)/(2*34+1.125)),sort(abs(res.p1)),xlab='Expected Half-Normal Order Stats',ylab='Ordered Abs Pearson Residuals')
# abline(a=0,b=1)
# abline(a=0,b=sqrt(phi),lty=2) 
```

interpretation: .................

The dispersion parameter is `r round(phi, 3)` for M2. After adjusting for over dispersion, it can be observed that the coefficients do not differ that much. However the covariate weight which was significant before adjusting for overdispersion becomes insignificant after adjusting for overdispersion.


## Problem 2
### 2-a
In this part, I fitted a Poisson model with log link to the data with area, year, and length as predictors.
```{r}

mod1 = glm(intensity ~ area+year+length, family=poisson(link = "log"), data=parasite_data)
summary(mod1)
```

`r round(mod1$coefficients[2], 3)` is the log rate ratio of the number of parasites in area 2 versus area 1, holding year and length of the fish constant. 

`r round(mod1$coefficients[3], 3)` is the log rate ratio of the number of parasites in area 3 versus area 1, holding year and length of the fish constant. 

`r round(mod1$coefficients[4], 3)` is the log rate ratio of the number of parasites in area 4 versus area 1, holding year and length of the fish constant. 

`r round(mod1$coefficients[5], 3)` is the log rate ratio of the number of parasites in year 2000 versus 1999, holding area and length of the fish constant. 

`r round(mod1$coefficients[6], 3)` is the log rate ratio of the number of parasites in year 2001 versus 1999, holding area and length of the fish constant. 

`r round(mod1$coefficients[7], 3)` is the log rate ratio of the number of parasites per each one unit increase in the length of the fish, holding area and year constant. 

(???) In general, it is expected to see more parasites in fishes that are in area 4 compared to one and in year 2000 compared to 1999. In other areas, and years, fewer number of parasites are expected compared to reference categories, and also we expect to see fewer number of parasites by increasing the length of the fish. Also, all these variables have p-values smaller than 0.05 which shows that they are significant.

### 2-b
Test for goodness of fit of the model in (a) and state conclusions.
```{r mod1_gof}

deviance_mod1 = mod1$deviance
df_mod1 =  mod1$df.residual
pval_mod1=1-pchisq(deviance_mod1,df=df_mod1)
```

To assess the good of fit of this model, I used Dec=viance analysis and observed that the model has deviance of `r deviance_mod1`. Comparing this result with $\chi^2$ with degree of freedom of `r df_mod1`, the p-value is `r round(pval_mod1, 3)`. This means that we should reject the null and conclude that the model does not fit the data well.

### 2-c
In this part I am interested in refit the model in part **a** that can account for extra zeros.

From `r nrow(parasite_data)` rows in dataset, there are `r parasite_data %>% filter(intensity == 0) %>% nrow()` observations with zero intensity of zero. We can consider two types of zeros in the context of this problem:

* True zeros: the strains which are not susceptible to parasites

* Pseudo zeros: the strains that are susceptible to parasites but have zero parasites int he time of testing, od the parasites have not been detected.So, I will fit a zero-inflated model.

I conditioned the model on area because the presence of parasite depends highly on the area we are investigating and I prefered to fix that when looking at the the difference between fish strains.
```{r zip}

mod2 = zeroinfl(intensity ~ year+length | area, data=parasite_data)
summary(mod2)
```

The model built has two parts: Count model and Zero-inflation model. 

**For the count model:**

Given that the fish strain is susceptible to parasites, `r round(mod2$coefficients$count[2], 3)` is the log rate ratio of the number of parasites in year 2000 versus 1999, holding length an darea constant. 

Given that the fish strain is susceptible to parasites, `r round(mod2$coefficients$count[3], 3)` is the log rate ratio of the number of parasites in year 2001 versus 1999, holding length an darea constant. 

Given that the fish strain is susceptible to parasites, `r round(mod2$coefficients$count[4], 3)` is the log rate ratio of the number of parasites per 1 unit increase in the length of the fish, holding length an darea constant.

**For the zero-inflated model:**

`r round(mod2$coefficients$zero[2], 3)` is the log odds ratio of being the fish strain susceptible to parasites in area 2 compared to area 1.

`r round(mod2$coefficients$zero[3], 3)` is the log odds ratio of being the fish strain susceptible to parasites in area 3 compared to area 1.

`r round(mod2$coefficients$zero[4], 3)` is the log odds ratio of being the fish strain susceptible to parasites in area 4 compared to area 1.

(???)We can see that the rate of susceptible strain is higher in areas 2 and 3 compared to 1, but it is lower in area 4 compared to area 1. Also, all these variables are highly significant with p-values of smaller than 0.05. 
